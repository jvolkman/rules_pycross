load("@bazel_skylib//rules:select_file.bzl", "select_file")
load("@rules_foreign_cc//foreign_cc:defs.bzl", "configure_make")

package(default_visibility = ["//visibility:public"])

config_setting(
    name = "macos_x86_64",
    constraint_values = [
        "@platforms//os:macos",
        "@platforms//cpu:x86_64",
    ],
)

config_setting(
    name = "macos_arm64",
    constraint_values = [
        "@platforms//os:macos",
        "@platforms//cpu:arm64",
    ],
)

config_setting(
    name = "linux_x86_64",
    constraint_values = [
        "@platforms//os:linux",
        "@platforms//cpu:x86_64",
    ],
)

configure_make(
    name = "postgresql",
    lib_source = "@postgresql//:all",
    configure_options = [
        "--without-readline",
        "--with-ssl=openssl",
    ] + select({
        ":macos_x86_64": ["--build=amd64-apple-darwin"],
        ":macos_arm64": ["--build=aarch64-apple-darwin"],
        ":linux_x86_64": ["--host=amd64-linux"],
    }),
    env = {
        "ZIC": "/usr/sbin/zic",
    },
    targets = [
        "-C src/bin install",
        "-C src/include install",
        "-C src/interfaces install",
        "-C doc install",
    ],
    deps = [
        "//third_party/openssl",
        "@zlib//:z",
    ],
    out_shared_libs = select({
        "@platforms//os:macos": ["libpq.dylib"],
        "@platforms//os:linux": ["libpq.so"],
    }),
    out_binaries = [
        "pg_config",
    ],
)
